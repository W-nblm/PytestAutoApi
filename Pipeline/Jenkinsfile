pipeline {
    agent any
    stages {
        stage('Print WorkSpace') {
            steps {
                script{
                    echo "Hello world"
                    echo "当前的工作目录: ${env.WORKSPACE}"
                }
            }
        }
        stage('准备 Python 环境') {
        steps {
            script {
                def venvExists = fileExists('venv/bin/activate')
                if (!venvExists) {
                    echo "未检测到虚拟环境，创建"
                    sh 'python3 -m venv venv'
                }
                echo "尝试安装依赖（支持断点续装）"
                sh '''
                    . venv/bin/activate
                    pip install -r requirements.txt \
                        --default-timeout=100 \
                        --retries=5 \
                        --cache-dir=/tmp/pip-cache \
                        -i https://pypi.tuna.tsinghua.edu.cn/simple || true
                '''
                }
            }
        }


        stage('执行python脚本'){
            steps {
                script{
                    sh "python3 ${env.WORKSPACE}/redis_main.py"
                }
            }
        }
    }
}