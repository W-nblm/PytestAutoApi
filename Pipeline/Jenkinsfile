pipeline {
    agent any

    parameters {
        choice(
            name: 'PYTHON_SCRIPT',
            choices: ['main.py', 'redis_main.py'],
            description: 'è¯·é€‰æ‹©è¦è¿è¡Œçš„ Python è„šæœ¬'
        )
    }

    environment {
        UV_CACHE_DIR = '/tmp/uv-cache'
        PIP_INDEX = 'https://pypi.tuna.tsinghua.edu.cn/simple'
    }

    stages {
        stage('åˆå§‹åŒ–ç¯å¢ƒ') {
            steps {
                echo 'ğŸ› ï¸ æ‰“å°å·¥ä½œç›®å½•å’Œ Python ç‰ˆæœ¬ä¿¡æ¯'
                sh 'pwd || true'
                sh 'python3 --version || true'
                sh 'pip3 --version || true'
            }
        }

        stage('å®‰è£… uvï¼ˆè‹¥æœªå®‰è£…ï¼‰') {
            steps {
                script {
                    echo 'ğŸ“¦ æ£€æŸ¥å¹¶å®‰è£… uv'
                    sh '''
                        if ! command -v uv >/dev/null 2>&1; then
                            echo "ğŸ”§ å®‰è£… uv..."
                            curl -LsSf https://astral.sh/uv/install.sh | sh
                            export PATH="$HOME/.local/bin:$PATH"
                        else
                            echo "âœ… uv å·²å®‰è£…"
                        fi
                        uv --version
                    '''
                }
            }
        }

        stage('å®‰è£…ä¾èµ–') {
            steps {
                echo "ğŸ“¦ ä½¿ç”¨ uv å®‰è£…ä¾èµ–"
                sh """
                    export PATH="$HOME/.local/bin:$PATH"
                    uv pip install -r requirements.txt \
                        --index-url=${PIP_INDEX} \
                        --cache-dir=${UV_CACHE_DIR}
                """
            }
        }

        stage('æ‰§è¡Œæ¥å£è‡ªåŠ¨åŒ–è„šæœ¬') {
            steps {
                echo "ğŸš€ æ‰§è¡Œ ${params.PYTHON_SCRIPT}"
                sh """
                    export PATH="$HOME/.local/bin:$PATH"
                    uv run python ${params.PYTHON_SCRIPT}
                """
            }
        }

        stage('ç”Ÿæˆ Excel æŠ¥å‘Š') {
            steps {
                echo "ğŸ“Š ç”Ÿæˆ Excel æŠ¥å‘Š"
                sh """
                    export PATH="$HOME/.local/bin:$PATH"
                    uv run python generate_report_main.py
                """
            }
        }
    }

    post {
        failure {
            echo 'âŒ æ„å»ºå¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—ã€‚'
        }
        success {
            echo 'âœ… æ„å»ºæˆåŠŸã€‚'
        }
    }
}
