pipeline {
    agent any
    parameters {
        choice(
            name: 'PYTHON_SCRIPT',
            choices: ['main.py','redis_main.py'],
            description: 'è¯·é€‰æ‹©è¦è¿è¡Œçš„ Python è„šæœ¬'
        )
    }

    environment {
        VENV_PATH = 'venv'
        PIP_INDEX = 'https://pypi.tuna.tsinghua.edu.cn/simple'
        PIP_CACHE = '/tmp/pip-cache'
        REQ_HASH_FILE = '.requirements.hash'
    }

    stages {
        stage('åˆå§‹åŒ–ç¯å¢ƒ') {
            steps {
                echo 'ğŸ› ï¸ æ‰“å°å·¥ä½œç›®å½•å’Œ Python ç‰ˆæœ¬ä¿¡æ¯'
                sh 'pwd || true'
                sh 'python3 --version || true'
                sh 'pip3 --version || true'
            }
        }

        stage('å‡†å¤‡ Python è™šæ‹Ÿç¯å¢ƒ') {
            steps {
                script {
                    def venvExists = fileExists("${VENV_PATH}/bin/activate")
                    if (!venvExists) {
                        echo "ğŸ“¦ æœªæ£€æµ‹åˆ°è™šæ‹Ÿç¯å¢ƒï¼Œæ­£åœ¨åˆ›å»º"
                        sh "python3 -m venv ${VENV_PATH}"
                    } else {
                        echo "âœ… è™šæ‹Ÿç¯å¢ƒå·²å­˜åœ¨ï¼Œè·³è¿‡åˆ›å»º"
                    }
                }
            }
        }

        stage('å®‰è£…ä¾èµ–ï¼ˆä»…åœ¨å˜æ›´æ—¶ï¼‰') {
            steps {
                script {
                    echo "ğŸ” æ£€æŸ¥ requirements.txt æ˜¯å¦å˜æ›´"
                    def currentHash = sh(script: "sha256sum requirements.txt | awk '{print \$1}'", returnStdout: true).trim()
                    def cachedHash = fileExists("${REQ_HASH_FILE}") ? readFile("${REQ_HASH_FILE}").trim() : ''

                    if (currentHash != cachedHash) {
                        echo "ğŸ“¦ requirements.txt æœ‰å˜æ›´ï¼Œå¼€å§‹å®‰è£…ä¾èµ–"
                        sh """
                            . ${VENV_PATH}/bin/activate && \
                            pip install -r requirements.txt \
                                --default-timeout=100 \
                                --retries=5 \
                                --cache-dir=${PIP_CACHE} \
                                -i ${PIP_INDEX}
                        """
                        writeFile file: "${REQ_HASH_FILE}", text: currentHash
                    } else {
                        echo "â© requirements.txt æ— å˜æ›´ï¼Œè·³è¿‡ä¾èµ–å®‰è£…"
                    }
                }
            }
        }

        stage('æ‰§è¡Œ æ¥å£è‡ªåŠ¨åŒ–Python è„šæœ¬') {
            steps {
                echo "ğŸš€ æ‰§è¡Œ main.py"
                sh """
                    . ${VENV_PATH}/bin/activate && \
                    python ${params.PYTHON_SCRIPT}
                """
            }
        }
                stage('ç”ŸæˆexcelæŠ¥å‘Š'){
            steps {
                echo "ğŸš€ ç”ŸæˆexcelæŠ¥å‘Š"
                sh """
                python generate_report_main.py
                """
            }
        }
    }

        
    post {
        failure {
            echo 'âŒ æ„å»ºå¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—ã€‚'
        }
        success {
            echo 'âœ… æ„å»ºæˆåŠŸã€‚'
        }
    }
}
