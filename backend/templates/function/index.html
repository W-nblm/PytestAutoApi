<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="utf-8" />
    <title>AI æµ‹è¯•ç”¨ä¾‹ç”Ÿæˆå¹³å°</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        background-color: #f8f9fa;
      }
      .page-title {
        font-weight: 600;
      }
      .table thead th {
        background-color: #f1f3f5;
      }
      .table-hover tbody tr:hover {
        background-color: #eef4ff;
      }
      .btn {
        border-radius: 6px;
      }
      .card {
        border-radius: 10px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
      }
      .toast-container {
        position: fixed;
        top: 1rem;
        right: 1rem;
        z-index: 1055;
      }
      .search-box input {
        border-radius: 8px;
        padding-left: 35px;
      }
      .search-icon {
        position: absolute;
        left: 10px;
        top: 50%;
        transform: translateY(-50%);
        color: #aaa;
      }
    </style>
  </head>

  <body>
    <div class="container py-5">
      <!-- é¡¶éƒ¨æ ‡é¢˜ -->
      <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
          <h1 class="page-title">ğŸ¤– AI æµ‹è¯•ç”¨ä¾‹ç”Ÿæˆå¹³å°</h1>
          <p class="text-muted mb-0">
            ä¸Šä¼ éœ€æ±‚æ–‡æ¡£ï¼Œè‡ªåŠ¨ç”Ÿæˆå¯å¯¼å‡ºçš„æµ‹è¯•ç”¨ä¾‹é›†
          </p>
        </div>
        <button
          class="btn btn-primary"
          data-bs-toggle="modal"
          data-bs-target="#uploadModal"
        >
          â• æ–°å»ºç”¨ä¾‹é›†
        </button>
      </div>

      <!-- æœç´¢æ¡† -->
      <div class="search-box position-relative mb-3">
        <i class="bi bi-search search-icon"></i>
        <input
          type="text"
          id="searchInput"
          class="form-control"
          placeholder="ğŸ” æœç´¢ç”¨ä¾‹é›†æ ‡é¢˜..."
        />
      </div>

      <!-- ç”¨ä¾‹åˆ—è¡¨ -->
      <div class="card p-4">
        <h5 class="mb-3">ğŸ“‚ æµ‹è¯•ç”¨ä¾‹åˆ—è¡¨</h5>
        <div class="table-responsive">
          <table class="table table-hover align-middle" id="caseTable">
            <thead>
              <tr>
                <th style="width: 5%">#</th>
                <th>ç”¨ä¾‹é›†æ ‡é¢˜</th>
                <th style="width: 20%">åˆ›å»ºæ—¶é—´</th>
                <th style="width: 10%">ç”¨ä¾‹æ•°</th>
                <th style="width: 25%" class="text-end">æ“ä½œ</th>
              </tr>
            </thead>
            <tbody>
              {% for c in cases|reverse %}
              <tr>
                <td>{{ loop.index }}</td>
                <td class="case-title">{{ c.title }}</td>
                <td>{{ c.timestamp }}</td>
                <td><span class="badge bg-secondary">{{ c.count }}</span></td>
                <td class="text-end">
                  <a
                    href="view/{{ c.timestamp }}"
                    class="btn btn-sm btn-outline-info me-1"
                    >ğŸ” æŸ¥çœ‹</a
                  >
                  <a
                    href="download/{{ c.timestamp }}"
                    class="btn btn-sm btn-outline-success me-1"
                    >ğŸ“¥ ä¸‹è½½</a
                  >
                  <button
                    class="btn btn-sm btn-outline-danger"
                    onclick="deleteCase('{{ c.timestamp }}')"
                  >
                    ğŸ—‘ åˆ é™¤
                  </button>
                </td>
              </tr>
              {% else %}
              <tr>
                <td colspan="5" class="text-center text-muted py-4">
                  æš‚æ— æ•°æ®ï¼Œè¯·ä¸Šä¼ æ–‡æ¡£ç”Ÿæˆæµ‹è¯•ç”¨ä¾‹ã€‚
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ä¸Šä¼ æ¨¡æ€æ¡† -->
    <div
      class="modal fade"
      id="uploadModal"
      tabindex="-1"
      aria-labelledby="uploadModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
          <form id="uploadForm" enctype="multipart/form-data">
            <div class="modal-header">
              <h5 class="modal-title" id="uploadModalLabel">ğŸ“„ ç”Ÿæˆæµ‹è¯•ç”¨ä¾‹</h5>
              <button
                type="button"
                class="btn-close"
                data-bs-dismiss="modal"
                aria-label="å…³é—­"
              ></button>
            </div>
            <div class="modal-body">
              <div class="mb-3">
                <label class="form-label">ç”¨ä¾‹é›†æ ‡é¢˜</label>
                <input
                  type="text"
                  name="title"
                  class="form-control"
                  placeholder="ä¾‹å¦‚ï¼šç™»å½•åŠŸèƒ½æµ‹è¯•"
                  required
                />
              </div>
              <div class="mb-3">
                <label class="form-label">ä¸Šä¼ æ–‡ä»¶ (.docx / .txt)</label>
                <input type="file" name="file" class="form-control" />
              </div>
              <div class="mb-3">
                <label class="form-label">æˆ–ç›´æ¥ç²˜è´´æ–‡æœ¬</label>
                <textarea
                  name="text"
                  class="form-control"
                  rows="6"
                  placeholder="ç²˜è´´éœ€æ±‚è¯´æ˜æ–‡æ¡£å†…å®¹..."
                ></textarea>
              </div>
            </div>
            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-secondary"
                data-bs-dismiss="modal"
              >
                å–æ¶ˆ
              </button>
              <button type="submit" class="btn btn-primary">ğŸš€ ç”Ÿæˆ</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Toast é€šçŸ¥ -->
    <div class="toast-container">
      <div
        id="toast"
        class="toast align-items-center text-bg-success border-0"
        role="alert"
      >
        <div class="d-flex">
          <div class="toast-body">æ“ä½œæˆåŠŸï¼</div>
          <button
            type="button"
            class="btn-close btn-close-white me-2 m-auto"
            data-bs-dismiss="toast"
          ></button>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.js"></script>
    <script>
      const toast = new bootstrap.Toast(document.getElementById("toast"));
      function showToast(msg) {
        document.querySelector("#toast .toast-body").textContent = msg;
        toast.show();
      }

      document
        .getElementById("uploadForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const formData = new FormData(e.target);
          try {
            showToast("â³ æ­£åœ¨ç”Ÿæˆæµ‹è¯•ç”¨ä¾‹ï¼Œè¯·ç¨å€™...");
            const res = await axios.post("/generate", formData);
            if (res.data.title) {
              showToast("âœ… å·²ç”Ÿæˆ " + res.data.count + " æ¡æµ‹è¯•ç”¨ä¾‹ï¼");
              setTimeout(() => location.reload(), 1000);
            }
          } catch (err) {
            alert("âŒ ç”Ÿæˆå¤±è´¥ï¼Œè¯·æ£€æŸ¥è¾“å…¥å†…å®¹");
          }
        });

      async function deleteCase(timestamp) {
        if (!confirm("ç¡®å®šåˆ é™¤è¯¥ç”¨ä¾‹é›†ï¼Ÿ")) return;
        await axios.delete(`/function/delete/${timestamp}`);
        showToast("ğŸ—‘ å·²åˆ é™¤");
        setTimeout(() => location.reload(), 1000);
      }

      // ğŸ” æœç´¢åŠŸèƒ½
      document
        .getElementById("searchInput")
        .addEventListener("input", function () {
          const keyword = this.value.toLowerCase();
          document.querySelectorAll("#caseTable tbody tr").forEach((row) => {
            const title = row
              .querySelector(".case-title")
              ?.textContent.toLowerCase();
            if (!title || title.includes(keyword)) {
              row.style.display = "";
            } else {
              row.style.display = "none";
            }
          });
        });
    </script>
  </body>
</html>
